<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Ares Terminal</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #050816;
      color: #e5e7eb;
      padding: 24px;
    }
    h1 {
      font-size: 1.8rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      margin-bottom: 4px;
    }
    h2 {
      font-size: 1rem;
      text-transform: uppercase;
      letter-spacing: 0.18em;
      color: #9ca3af;
      margin-bottom: 10px;
    }
    .subtitle {
      font-size: 0.9rem;
      color: #9ca3af;
      margin-bottom: 16px;
    }
    .date {
      font-size: 0.95rem;
      color: #d1d5db;
      margin-bottom: 16px;
    }
    .top-row {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 16px;
      margin-bottom: 20px;
    }
    .top-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 16px;
    }
    @media (max-width: 1100px) {
      .grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }
    @media (max-width: 900px) {
      .grid {
        grid-template-columns: 1fr;
      }
    }
    .card {
      background: radial-gradient(circle at top left, #1f2937, #020617);
      border-radius: 16px;
      padding: 16px 16px 18px;
      border: 1px solid rgba(148, 163, 184, 0.2);
      box-shadow: 0 20px 40px rgba(15, 23, 42, 0.7);
    }
    .card-title-row {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 8px;
      gap: 8px;
    }
    .card-tag {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.5);
      color: #9ca3af;
      white-space: nowrap;
    }
    label {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: #9ca3af;
      display: block;
      margin-bottom: 4px;
    }
    input, textarea, select {
      width: 100%;
      background: rgba(15, 23, 42, 0.9);
      border-radius: 10px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      padding: 6px 9px;
      color: #e5e7eb;
      font-size: 0.85rem;
      outline: none;
      margin-bottom: 8px;
      resize: vertical;
    }
    input:focus,
    textarea:focus,
    select:focus {
      border-color: #38bdf8;
      box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.5);
    }
    textarea {
      min-height: 72px;
      max-height: 220px;
    }
    .small-row {
      display: grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap: 8px;
    }
    .tiny-row {
      display: grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap: 8px;
    }
    .pill-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 10px;
      margin-top: 4px;
    }
    .pill {
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 0.75rem;
      border: 1px solid rgba(148, 163, 184, 0.6);
      cursor: pointer;
      user-select: none;
      white-space: nowrap;
      color: #e5e7eb;
    }
    .pill.active {
      background: linear-gradient(to right, #22c55e, #6ee7b7);
      border-color: transparent;
      color: #022c22;
      font-weight: 600;
    }
    .pill.orange.active {
      background: linear-gradient(to right, #f97316, #facc15);
      color: #111827;
    }
    .pill.red.active {
      background: linear-gradient(to right, #ef4444, #f97316);
      color: #111827;
    }
    .section-label {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: #9ca3af;
      margin-top: 8px;
      margin-bottom: 4px;
    }
    .status-strip {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 6px;
      margin-bottom: 6px;
    }
    .status-pill {
      border-radius: 999px;
      padding: 2px 10px;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      border: 1px solid rgba(148,163,184,0.6);
      color: #9ca3af;
    }
    .status-pill.good {
      border-color: #22c55e;
      color: #bbf7d0;
    }
    .status-pill.warning {
      border-color: #f97316;
      color: #fed7aa;
    }
    .status-pill.bad {
      border-color: #ef4444;
      color: #fecaca;
    }
    button {
      background: radial-gradient(circle at top left, #22c55e, #16a34a);
      color: #022c22;
      border-radius: 999px;
      border: 1px solid #22c55e;
      padding: 6px 12px;
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      cursor: pointer;
    }
    button:hover {
      border-color: #38bdf8;
    }
    .ares-mode {
      font-size: 0.85rem;
      color: #e5e7eb;
      max-width: 620px;
      line-height: 1.4;
    }
    .ares-highlight {
      color: #f97316;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      font-size: 0.7rem;
      display: block;
      margin-bottom: 4px;
    }
    .date-nav {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 8px;
    }
    .ghost-btn {
      background: transparent;
      border-color: rgba(148, 163, 184, 0.5);
      padding: 4px 8px;
      font-size: 0.8rem;
    }
    .history-table-wrapper {
      max-height: 220px;
      overflow-y: auto;
      margin-top: 8px;
      border-radius: 8px;
      border: 1px solid rgba(148, 163, 184, 0.4);
    }
    .history-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
    }
    .history-table th,
    .history-table td {
      padding: 6px 8px;
      border-bottom: 1px solid rgba(31, 41, 55, 1);
    }
    .history-table th {
      text-align: left;
      font-weight: 600;
      color: #9ca3af;
      position: sticky;
      top: 0;
      background: #020617;
    }
    .history-table tr:nth-child(even) td {
      background: rgba(15, 23, 42, 0.6);
    }
    .footer {
      font-size: 0.75rem;
      color: #6b7280;
      margin-top: 12px;
    }
  </style>
</head>
<body>
  <header class="top-row">
    <div>
      <h1>Ares Terminal</h1>
      <p class="subtitle">Laptop Control Panel — Training, Discipline, and Daily Systems</p>
      <div class="date-nav">
        <button class="ghost-btn" id="prevDay">&larr;</button>
        <p class="date" id="currentDate">Loading date…</p>
        <button class="ghost-btn" id="nextDay">&rarr;</button>
      </div>
    </div>
    <div class="top-actions">
      <button id="saveDay">Save Day</button>
      <button id="resetToday">Reset Day</button>
      <button id="hardReset">Hard Reset</button>
    </div>
  </header>

  <section style="margin-bottom: 18px;">
    <div class="ares-mode">
      <span class="ares-highlight">Ares Mode</span>
      Discipline is the default. You input the data. I show you whether your actions match the athlete you say you want to be.
      Use this terminal every morning and night:
      <br /><br />
      • Morning: Set your training focus, non-negotiables, and schedule.<br />
      • Night: Log what actually happened. Rate yourself. Adjust tomorrow.
    </div>
  </section>

  <main class="grid">
    <!-- Column 1: Vitals -->
    <section class="card">
      <div class="card-title-row">
        <h2>Vitals & Intake</h2>
        <span class="card-tag">FOOT / FUEL</span>
      </div>

      <div class="tiny-row">
        <div>
          <label for="weight">Weight (lbs)</label>
          <input id="weight" type="number" step="0.1" placeholder="e.g. 200.4" />
        </div>
        <div>
          <label for="sleep">Sleep (hrs)</label>
          <input id="sleep" type="number" step="0.1" placeholder="e.g. 7.5" />
        </div>
        <div>
          <label for="energy">Energy (1–10)</label>
          <input id="energy" type="number" min="1" max="10" step="1" placeholder="e.g. 7" />
        </div>
      </div>

      <div class="small-row">
        <div>
          <label for="calories">Calories</label>
          <input id="calories" type="number" step="1" placeholder="e.g. 2300" />
        </div>
        <div>
          <label for="protein">Protein (g)</label>
          <input id="protein" type="number" step="1" placeholder="e.g. 190" />
        </div>
      </div>

      <div class="small-row">
        <div>
          <label for="steps">Steps</label>
          <input id="steps" type="number" step="1" placeholder="e.g. 8000" />
        </div>
        <div>
          <label for="water">Water (L)</label>
          <input id="water" type="number" step="0.1" placeholder="e.g. 3.0" />
        </div>
      </div>

      <p class="section-label">Mood & Screen</p>
      <div class="small-row">
        <div>
          <label for="mood">Mood (1–10)</label>
          <input id="mood" type="number" min="1" max="10" step="1" placeholder="e.g. 8" />
        </div>
        <div>
          <label for="screen">Screen Time (hrs)</label>
          <input id="screen" type="number" step="0.1" placeholder="e.g. 4.5" />
        </div>
      </div>

      <p class="section-label">Notes</p>
      <textarea id="vitalNotes" placeholder="Bloat, digestion, cravings, soreness, meds/supps, anything notable."></textarea>

      <p class="section-label">Status Strip</p>
      <div class="status-strip">
        <span class="status-pill good">On target</span>
        <span class="status-pill warning">Calories high?</span>
        <span class="status-pill bad">Sleep debt?</span>
      </div>
    </section>

    <!-- Column 2: Training & Execution -->
    <section class="card">
      <div class="card-title-row">
        <h2>Training & Execution</h2>
        <span class="card-tag">FOOT / IRON</span>
      </div>

      <p class="section-label">Training Focus (Today)</p>
      <textarea id="trainFocus" placeholder="e.g. Upper push strength + speed work. Groove bench technique, attack top set."></textarea>

      <p class="section-label">Session Type</p>
      <div class="pill-row" data-group="sessionType">
        <div class="pill" data-value="Football">Football</div>
        <div class="pill" data-value="Upper">Upper</div>
        <div class="pill" data-value="Lower">Lower</div>
        <div class="pill" data-value="Full">Full</div>
        <div class="pill" data-value="Speed">Speed</div>
        <div class="pill" data-value="Conditioning">Conditioning</div>
      </div>

      <p class="section-label">Execution Grade</p>
      <div class="pill-row" data-group="execution">
        <div class="pill orange" data-value="A+">A+</div>
        <div class="pill orange" data-value="A">A</div>
        <div class="pill orange" data-value="B">B</div>
        <div class="pill orange" data-value="C">C</div>
        <div class="pill red" data-value="D/F">D / F</div>
      </div>

      <p class="section-label">Training Notes</p>
      <textarea id="trainingNotes" placeholder="Top sets, volume, speed work, how the body felt, anything to adjust tomorrow."></textarea>

      <p class="section-label">Non-Negotiables (Today)</p>
      <div class="pill-row" data-group="nonneg">
        <div class="pill" data-value="No phone in bed">No phone in bed</div>
        <div class="pill" data-value="No scrolling after 10pm">No scrolling after 10pm</div>
        <div class="pill" data-value="Hit protein target">Hit protein target</div>
        <div class="pill" data-value="Stretch 10 min">Stretch 10 min</div>
        <div class="pill" data-value="Walk after dinner">Walk after dinner</div>
      </div>

      <p class="section-label">Execution Rules</p>
      <div class="pill-row" data-group="rules">
        <div class="pill" data-value="No skipped warmup">No skipped warmup</div>
        <div class="pill" data-value="No ego lifting">No ego lifting</div>
        <div class="pill" data-value="Film key sets">Film key sets</div>
        <div class="pill" data-value="Log weights">Log weights</div>
      </div>
    </section>

    <!-- Column 3: ACAD / Night Audit -->
    <section class="card">
      <div class="card-title-row">
        <h2>Acad / Audit</h2>
        <span class="card-tag">ACAD / LIFE</span>
      </div>

      <p class="section-label">Academic / Deep Work Block</p>
      <textarea id="acadBlock" placeholder="e.g. 10–12: Math + Physics. No phone. All assignments into calendar."></textarea>

      <p class="section-label">Top 3 for Today</p>
      <textarea id="top3" placeholder="1) &#10;2) &#10;3)"></textarea>

      <p class="section-label">Lifestyle / Discipline</p>
      <div class="pill-row" data-group="lifestyle">
        <div class="pill" data-value="Phone under control">Phone under control</div>
        <div class="pill" data-value="Ate like athlete">Ate like athlete</div>
        <div class="pill" data-value="Sleep dialed">Sleep dialed</div>
        <div class="pill" data-value="No junk dopamine">No junk dopamine</div>
        <div class="pill" data-value="Tasks done">Tasks done</div>
      </div>

      <p class="section-label">Night Audit</p>
      <textarea id="audit" placeholder="What was a win? What was sloppy? What do you fix tomorrow? Did you live like the athlete you claim to be?"></textarea>

      <p class="section-label">Self-Rating (0–10)</p>
      <div class="small-row">
        <div>
          <label for="rateDiscipline">Discipline</label>
          <input id="rateDiscipline" type="number" min="0" max="10" step="1" placeholder="0–10" />
        </div>
        <div>
          <label for="rateFocus">Focus</label>
          <input id="rateFocus" type="number" min="0" max="10" step="1" placeholder="0–10" />
        </div>
      </div>
    </section>

    <!-- Column: History & Weekly View -->
    <section class="card">
      <div class="card-title-row">
        <h2>History & Weekly View</h2>
        <span class="card-tag">Log</span>
      </div>
      <p class="section-label">Last 7 days (weight / calories / discipline)</p>
      <div class="history-table-wrapper">
        <table class="history-table">
          <thead>
            <tr>
              <th>Date</th>
              <th>Weight</th>
              <th>Calories</th>
              <th>Discipline</th>
            </tr>
          </thead>
          <tbody id="historyBody">
            <!-- Filled by JS -->
          </tbody>
        </table>
      </div>
    </section>
  </main>

  <footer class="footer">
    Tip: Bookmark this site and set it as your first tab. Open it every morning and close it only when the Night Audit is complete.
  </footer>

  <script>
    const STORAGE_PREFIX = "aresTerminal_v1_";
    const FIELD_IDS = [
      "weight","sleep","energy","calories","protein","steps","water",
      "mood","screen","vitalNotes",
      "trainFocus","acadBlock","trainingNotes",
      "top3","audit",
      "rateDiscipline","rateFocus"
    ];

    let currentDate = new Date();
    let currentDateKey = null;
    let autoSaveTimer = null;
    let isLoadingDay = false;

    function formatDateKey(d) {
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return `${y}-${m}-${day}`;
    }

    function updateDateDisplay() {
      const el = document.getElementById("currentDate");
      if (!el || !currentDateKey) return;
      const options = { weekday: "long", year: "numeric", month: "long", day: "numeric" };
      el.textContent = currentDate.toLocaleDateString(undefined, options);
    }

    function collectCurrentData() {
      const data = {};
      FIELD_IDS.forEach(id => {
        const el = document.getElementById(id);
        if (el) data[id] = el.value;
      });
      return data;
    }

    async function saveDay(manual = false) {
      if (!currentDateKey) return;
      const payload = {
        date: currentDateKey,
        data: collectCurrentData()
      };
      try {
        await fetch("/api/entries", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        if (manual) {
          console.log("Manual save complete for", currentDateKey);
        }
        renderHistoryTable(); // update weekly view after saves
      } catch (err) {
        console.error("Error saving day:", err);
      }
    }

    function scheduleAutoSave() {
      if (isLoadingDay) return;
      if (autoSaveTimer) clearTimeout(autoSaveTimer);
      autoSaveTimer = setTimeout(() => {
        saveDay(false);
      }, 800); // debounce ~0.8s
    }

    async function loadDay(dateKey) {
      isLoadingDay = true;
      try {
        const res = await fetch(`/api/entries?date=${encodeURIComponent(dateKey)}`);
        if (!res.ok) {
          console.warn("No entry yet for", dateKey);
        }
        const json = await res.json().catch(() => ({}));
        const data = json && json.data ? json.data : {};
        FIELD_IDS.forEach(id => {
          const el = document.getElementById(id);
          if (el) el.value = data[id] ?? "";
        });
      } catch (err) {
        console.error("Error loading day:", err);
      } finally {
        isLoadingDay = false;
      }
      renderHistoryTable();
    }

    async function renderHistoryTable() {
      const body = document.getElementById("historyBody");
      if (!body) return;
      body.innerHTML = "";

      const toDate = new Date(currentDate);
      const fromDate = new Date(currentDate);
      fromDate.setDate(fromDate.getDate() - 6);

      const fromKey = formatDateKey(fromDate);
      const toKey = formatDateKey(toDate);

      try {
        const res = await fetch(`/api/entries/range?from=${encodeURIComponent(fromKey)}&to=${encodeURIComponent(toKey)}`);
        const json = await res.json();
        const entries = json.entries || {};

        const days = [];
        const temp = new Date(fromDate);
        while (temp <= toDate) {
          days.push(formatDateKey(temp));
          temp.setDate(temp.getDate() + 1);
        }

        let hasAny = false;
        days.forEach(key => {
          const d = entries[key] || {};
          if (Object.keys(d).length > 0) hasAny = true;

          const row = document.createElement("tr");
          const cells = [
            key,
            d.weight || "-",
            d.calories || "-",
            d.rateDiscipline || "-"
          ];
          cells.forEach(text => {
            const td = document.createElement("td");
            td.textContent = text;
            row.appendChild(td);
          });
          body.appendChild(row);
        });

        if (!hasAny) {
          body.innerHTML = "";
          const row = document.createElement("tr");
          const td = document.createElement("td");
          td.colSpan = 4;
          td.textContent = "Fill out at least one day to see your weekly history.";
          row.appendChild(td);
          body.appendChild(row);
        }
      } catch (err) {
        console.error("Error rendering history:", err);
        const row = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 4;
        td.textContent = "Error loading history.";
        row.appendChild(td);
        body.appendChild(row);
      }
    }

    function initFields() {
      FIELD_IDS.forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        el.addEventListener("input", scheduleAutoSave);
        el.addEventListener("change", scheduleAutoSave);
      });
    }

    function storageKey(id) {
      return STORAGE_PREFIX + id;
    }

    function initPills() {
      document.querySelectorAll(".pill-row").forEach(row => {
        const group = row.getAttribute("data-group");
        const pills = row.querySelectorAll(".pill");
        const key = storageKey("pill_" + group);
        const saved = localStorage.getItem(key);
        if (saved) {
          const values = saved.split("||");
          pills.forEach(p => {
            if (values.includes(p.getAttribute("data-value"))) {
              p.classList.add("active");
            }
          });
        }
        row.addEventListener("click", e => {
          const pill = e.target.closest(".pill");
          if (!pill) return;

          if (group === "execution" || group === "sessionType") {
            pills.forEach(p => p.classList.remove("active"));
            pill.classList.add("active");
          } else {
            pill.classList.toggle("active");
          }

          const activeValues = Array.from(pills)
            .filter(p => p.classList.contains("active"))
            .map(p => p.getAttribute("data-value"));
          localStorage.setItem(key, activeValues.join("||"));
        });
      });
    }

    function resetToday() {
      const confirmReset = confirm("Reset fields for this day? This will clear entries for this date.");
      if (!confirmReset) return;
      FIELD_IDS.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = "";
      });
      saveDay(true);
    }

    function hardReset() {
      const confirmReset = confirm(
        "Hard reset will clear pill states and local cache. It does NOT delete backend history yet. Proceed?"
      );
      if (!confirmReset) return;

      Object.keys(localStorage)
        .filter(k => k.startsWith(STORAGE_PREFIX))
        .forEach(k => localStorage.removeItem(k));

      window.location.reload();
    }

    function shiftDay(delta) {
      // Optionally save current day before switching
      saveDay(false);
      currentDate.setDate(currentDate.getDate() + delta);
      currentDateKey = formatDateKey(currentDate);
      updateDateDisplay();
      loadDay(currentDateKey);
    }

    function initButtons() {
      const saveBtn = document.getElementById("saveDay");
      const resetBtn = document.getElementById("resetToday");
      const hardResetBtn = document.getElementById("hardReset");
      const prevDayBtn = document.getElementById("prevDay");
      const nextDayBtn = document.getElementById("nextDay");

      if (saveBtn) saveBtn.addEventListener("click", () => saveDay(true));
      if (resetBtn) resetBtn.addEventListener("click", resetToday);
      if (hardResetBtn) hardResetBtn.addEventListener("click", hardReset);
      if (prevDayBtn) prevDayBtn.addEventListener("click", () => shiftDay(-1));
      if (nextDayBtn) nextDayBtn.addEventListener("click", () => shiftDay(1));
    }

    function init() {
      currentDate = new Date();
      currentDateKey = formatDateKey(currentDate);
      updateDateDisplay();
      initFields();
      initPills();
      initButtons();
      loadDay(currentDateKey);
    }

    document.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>
